<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ChurchReport · Emerge in Christ</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;1,400&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#0C0A14;--surface:#131020;--surface2:#1A1630;--surface3:#211D3A;
  --border:#2A2550;--accent:#8B5CF6;--accent2:#A78BFA;--accent3:#C4B5FD;
  --gold:#F59E0B;--success:#10B981;--danger:#EF4444;
  --text:#F1EFF8;--text2:#A199C4;--text3:#5A5280;
  --font-display:'Cinzel',serif;--font-body:'DM Sans',sans-serif;
  --sidebar:260px;--header:60px;--radius:12px;
  --shadow:0 4px 24px rgba(139,92,246,.15);
}
html,body{height:100%;font-family:var(--font-body);background:var(--bg);color:var(--text);overflow:hidden;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px;}

/* LAYOUT */
#app{display:flex;height:100vh;overflow:hidden;}
#sidebar{width:var(--sidebar);min-width:var(--sidebar);background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;transition:transform .3s;z-index:100;overflow:hidden;}
#main{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
#topbar{height:var(--header);background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;}
#content{flex:1;overflow-y:auto;padding:24px;}

/* SIDEBAR */
.sidebar-logo{padding:18px 16px 14px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);flex-shrink:0;}
.logo-placeholder{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--gold));display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;flex-shrink:0;}
.logo-img-wrap{width:34px;height:34px;border-radius:8px;overflow:hidden;flex-shrink:0;}
.logo-img-wrap img{width:100%;height:100%;object-fit:cover;}
.logo-text span:first-child{display:block;font-family:var(--font-display);font-size:10.5px;color:var(--text);font-weight:600;letter-spacing:.4px;}
.logo-text span:last-child{display:block;font-size:10px;color:var(--text3);}
.sidebar-badge{margin:10px 12px;background:var(--surface3);border:1px solid var(--border);border-radius:10px;padding:9px 12px;flex-shrink:0;}
.sidebar-badge .ext-name{font-size:12px;font-weight:600;color:var(--accent3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar-badge .ext-role{font-size:10px;color:var(--text3);}
.sidebar-nav{flex:1;overflow-y:auto;padding:6px 0;}
.nav-group{padding:8px 14px 2px;font-size:10px;font-weight:600;letter-spacing:1.5px;color:var(--text3);text-transform:uppercase;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 16px;margin:1px 8px;border-radius:9px;cursor:pointer;font-size:13px;color:var(--text2);transition:all .15s;border:none;background:none;width:calc(100% - 16px);text-align:left;font-family:var(--font-body);}
.nav-item:hover{background:var(--surface3);color:var(--text);}
.nav-item.active{background:linear-gradient(135deg,rgba(139,92,246,.22),rgba(167,139,250,.08));color:var(--accent3);border:1px solid rgba(139,92,246,.28);}
.nav-icon{width:18px;text-align:center;font-size:14px;}
.sidebar-footer{padding:12px;border-top:1px solid var(--border);flex-shrink:0;}
.btn-logout{width:100%;padding:8px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:9px;color:#EF4444;font-size:12px;cursor:pointer;font-family:var(--font-body);transition:all .2s;}
.btn-logout:hover{background:rgba(239,68,68,.2);}

/* TOPBAR */
.topbar-title{font-family:var(--font-display);font-size:14px;font-weight:600;color:var(--text);}
.topbar-sub{font-size:11px;color:var(--text3);}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:10px;}
.topbar-badge{background:var(--surface3);border:1px solid var(--border);border-radius:20px;padding:4px 12px;font-size:11px;color:var(--text2);}
.menu-btn{background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;padding:4px;display:none;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:.06;background:var(--accent);}
.stat-label{font-size:10.5px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;}
.stat-value{font-family:var(--font-display);font-size:24px;color:var(--text);font-weight:700;line-height:1.2;}
.stat-sub{font-size:11px;color:var(--text3);margin-top:4px;}
.stat-icon{position:absolute;top:16px;right:16px;font-size:20px;opacity:.35;}

/* GRIDS */
.grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;}
.grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;}
.grid-auto{display:grid;grid-template-columns:repeat(auto-fill,minmax(290px,1fr));gap:14px;}

/* FORM */
.form-section-title{font-family:var(--font-display);font-size:11px;color:var(--accent3);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border);}
.form-row{display:grid;gap:12px;margin-bottom:12px;}
.cols-2{grid-template-columns:1fr 1fr;}
.cols-3{grid-template-columns:1fr 1fr 1fr;}
.cols-5{grid-template-columns:repeat(5,1fr);}
label{display:block;font-size:10.5px;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;margin-bottom:5px;}
input,select,textarea{width:100%;background:var(--surface3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:var(--font-body);font-size:13px;outline:none;transition:border-color .2s;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
select option{background:var(--surface3);color:var(--text);}
textarea{resize:vertical;min-height:80px;}
input[type="color"]{padding:2px 4px;height:38px;cursor:pointer;}
input[type="number"]{-moz-appearance:textfield;}
input[type="number"]::-webkit-outer-spin-button,input[type="number"]::-webkit-inner-spin-button{-webkit-appearance:none;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:9px 16px;border-radius:9px;font-family:var(--font-body);font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .2s;white-space:nowrap;text-decoration:none;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#7C3AED);color:#fff;box-shadow:0 4px 14px rgba(139,92,246,.3);}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(139,92,246,.4);}
.btn-secondary{background:var(--surface3);color:var(--text2);border:1px solid var(--border);}
.btn-secondary:hover{background:var(--surface2);color:var(--text);}
.btn-danger{background:rgba(239,68,68,.12);color:#EF4444;border:1px solid rgba(239,68,68,.3);}
.btn-danger:hover{background:rgba(239,68,68,.22);}
.btn-success{background:rgba(16,185,129,.12);color:#10B981;border:1px solid rgba(16,185,129,.3);}
.btn-success:hover{background:rgba(16,185,129,.22);}
.btn-gold{background:linear-gradient(135deg,var(--gold),#D97706);color:#fff;}
.btn-gold:hover{transform:translateY(-1px);}
.btn-sm{padding:6px 11px;font-size:12px;}
.btn-icon{padding:7px;border-radius:8px;}
.w-full{width:100%;justify-content:center;}

/* TABLE */
.table-wrap{overflow-x:auto;border-radius:var(--radius);border:1px solid var(--border);}
table{width:100%;border-collapse:collapse;}
thead tr{background:var(--surface3);}
th{padding:10px 14px;font-size:10.5px;font-weight:600;color:var(--text3);text-transform:uppercase;letter-spacing:.7px;text-align:left;white-space:nowrap;}
td{padding:10px 14px;font-size:13px;color:var(--text2);border-top:1px solid var(--border);}
tbody tr:hover td{background:rgba(139,92,246,.05);color:var(--text);}
.td-bold{font-weight:600;color:var(--text);}

/* BADGES */
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-purple{background:rgba(139,92,246,.18);color:var(--accent3);border:1px solid rgba(139,92,246,.28);}
.badge-green{background:rgba(16,185,129,.12);color:#10B981;border:1px solid rgba(16,185,129,.25);}
.badge-gold{background:rgba(245,158,11,.12);color:var(--gold);border:1px solid rgba(245,158,11,.25);}

/* PAGE HEADER */
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:22px;gap:12px;}
.page-header h1{font-family:var(--font-display);font-size:20px;color:var(--text);}
.page-header p{font-size:12px;color:var(--text3);margin-top:3px;}

/* MODAL */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(5px);z-index:1000;display:flex;align-items:center;justify-content:center;padding:20px;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:100%;max-width:680px;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;}
.modal-lg{max-width:860px;}
.modal-header{padding:18px 22px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.modal-header h2{font-family:var(--font-display);font-size:15px;color:var(--text);}
.modal-body{padding:22px;overflow-y:auto;flex:1;}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;}
.modal-close{background:none;border:none;color:var(--text3);cursor:pointer;font-size:20px;padding:4px;line-height:1;}
.modal-close:hover{color:var(--text);}

/* LOGIN */
#login-screen{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;align-items:center;justify-content:center;overflow-y:auto;}
.login-wrap{width:100%;max-width:400px;padding:20px;}
.login-logo{text-align:center;margin-bottom:28px;}
.login-icon{width:64px;height:64px;border-radius:16px;background:linear-gradient(135deg,var(--accent),var(--gold));display:inline-flex;align-items:center;justify-content:center;font-size:28px;margin-bottom:12px;overflow:hidden;}
.login-icon img{width:100%;height:100%;object-fit:cover;}
.login-logo h1{font-family:var(--font-display);font-size:20px;color:var(--text);}
.login-logo p{font-size:12px;color:var(--text3);margin-top:4px;}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:26px;}
.login-tabs{display:flex;gap:8px;margin-bottom:18px;}
.login-tab{flex:1;padding:9px;border-radius:9px;border:1px solid var(--border);background:none;color:var(--text3);font-family:var(--font-body);font-size:13px;cursor:pointer;transition:all .2s;}
.login-tab.active{background:rgba(139,92,246,.18);color:var(--accent3);border-color:var(--accent);}
.login-error{background:rgba(239,68,68,.12);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:10px 14px;font-size:12px;color:#EF4444;margin-bottom:14px;display:none;}
.login-panel{display:none;}
.login-panel.active{display:block;}

/* EXT CARD */
.ext-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:all .2s;position:relative;overflow:hidden;}
.ext-card::after{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--ext-color,var(--accent));}
.ext-card:hover{border-color:var(--ext-color,var(--accent));transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,.3);}
.ext-card-name{font-family:var(--font-display);font-size:14px;color:var(--text);margin-bottom:3px;}
.ext-card-ville{font-size:11px;color:var(--text3);margin-bottom:10px;}
.ext-mini-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;}
.ext-stat-val{font-size:17px;font-weight:700;color:var(--text);}
.ext-stat-lbl{font-size:10px;color:var(--text3);}

/* PROGRESS */
.progress-bar{height:5px;background:var(--surface3);border-radius:4px;overflow:hidden;}
.progress-fill{height:100%;border-radius:4px;transition:width .5s ease;}

/* RAPPORT UI */
.total-box{background:var(--surface3);border:1px solid var(--accent);border-radius:10px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;}
.total-box-label{font-size:11px;color:var(--text3);}
.total-box-value{font-family:var(--font-display);font-size:17px;color:var(--accent3);}
.calc-box{background:var(--surface3);border-radius:10px;padding:12px 16px;font-size:13px;}
.calc-row{display:flex;justify-content:space-between;padding:3px 0;color:var(--text2);}
.calc-row.total-row{color:var(--accent3);font-weight:600;border-top:1px solid var(--border);margin-top:5px;padding-top:7px;}

/* STEPPER */
.stepper{display:flex;align-items:center;margin-bottom:22px;gap:0;}
.step-item{display:flex;align-items:center;flex:1;}
.step-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid var(--border);color:var(--text3);background:var(--surface3);transition:all .3s;flex-shrink:0;cursor:pointer;}
.step-dot.s-active{border-color:var(--accent);color:var(--accent3);background:rgba(139,92,246,.15);}
.step-dot.s-done{border-color:var(--success);color:#10B981;background:rgba(16,185,129,.12);}
.step-lbl{font-size:10px;color:var(--text3);margin-left:6px;white-space:nowrap;}
.step-lbl.s-active{color:var(--accent3);}
.step-connector{flex:1;height:1px;background:var(--border);margin:0 8px;}

/* DYNAMIC ROWS */
.dep-row,.conv-row{display:grid;gap:8px;align-items:center;margin-bottom:8px;}
.dep-row{grid-template-columns:1fr 130px auto;}
.conv-row{grid-template-columns:1fr 1fr auto;}

/* CHART */
.chart-wrap{position:relative;height:220px;}

/* FILTER BAR */
.filter-bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:14px;}
.filter-bar input,.filter-bar select{width:auto;flex:1;min-width:130px;}

/* UTILS */
.flex{display:flex;}.items-center{align-items:center;}.justify-between{justify-content:space-between;}.gap-8{gap:8px;}.gap-12{gap:12px;}.gap-16{gap:16px;}
.mt-4{margin-top:4px;}.mt-8{margin-top:8px;}.mt-12{margin-top:12px;}.mt-16{margin-top:16px;}.mt-20{margin-top:20px;}
.mb-8{margin-bottom:8px;}.mb-12{margin-bottom:12px;}.mb-16{margin-bottom:16px;}.mb-20{margin-bottom:20px;}
.text-sm{font-size:13px;}.text-xs{font-size:11px;}.text-muted{color:var(--text3);}.text-accent{color:var(--accent3);}.font-bold{font-weight:600;}
.hidden{display:none!important;}

/* TOAST */
#toast-wrap{position:fixed;bottom:20px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;pointer-events:none;}
.toast{background:var(--surface3);border:1px solid var(--border);border-radius:10px;padding:11px 16px;font-size:13px;color:var(--text);display:flex;align-items:center;gap:10px;min-width:220px;animation:toastIn .3s ease;box-shadow:var(--shadow);}
.toast.t-success{border-color:rgba(16,185,129,.4);background:rgba(16,185,129,.1);color:#10B981;}
.toast.t-error{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.1);color:#EF4444;}
@keyframes toastIn{from{transform:translateX(110%);opacity:0;}to{transform:translateX(0);opacity:1;}}
@keyframes toastOut{to{transform:translateX(110%);opacity:0;}}

/* RESPONSIVE */
@media(max-width:900px){
  #sidebar{position:fixed;top:0;bottom:0;left:0;transform:translateX(-100%);}
  #sidebar.open{transform:translateX(0);}
  .menu-btn{display:block;}
  .grid-4{grid-template-columns:repeat(2,1fr);}
  .grid-3{grid-template-columns:repeat(2,1fr);}
}
@media(max-width:580px){
  .grid-4,.grid-3,.grid-2{grid-template-columns:1fr;}
  #content{padding:14px;}
  .page-header{flex-direction:column;}
  .cols-5{grid-template-columns:repeat(2,1fr);}
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen">
  <div class="login-wrap">
    <div class="login-logo">
      <div class="login-icon" id="login-icon">${ICONS.cross}</div>
      <h1>Emerge in Christ</h1>
      <p>Système de Gestion des Rapports</p>
    </div>
    <div class="login-card">
      <div class="login-tabs">
        <button class="login-tab active" onclick="switchTab('extension')">${ICONS.building} Extension</button>
        <button class="login-tab" onclick="switchTab('admin')">${ICONS.shield} Administrateur</button>
      </div>
      <div id="login-error" class="login-error"></div>
      <div class="login-panel active" id="panel-extension">
        <div class="form-row"><label>Extension</label><select id="ext-select"></select></div>
        <div class="form-row"><label>Mot de passe</label><input type="password" id="ext-pw" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin('extension')"/></div>
        <button class="btn btn-primary w-full mt-12" onclick="doLogin('extension')">Se connecter</button>
      </div>
      <div class="login-panel" id="panel-admin">
        <div class="form-row"><label>Mot de passe administrateur</label><input type="password" id="admin-pw" placeholder="••••••••" onkeydown="if(event.key==='Enter')doLogin('admin')"/></div>
        <button class="btn btn-primary w-full mt-12" onclick="doLogin('admin')">Connexion Admin</button>
      </div>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" style="display:none">
  <aside id="sidebar">
    <div class="sidebar-logo">
      <div id="sb-logo-wrap"><div class="logo-placeholder">${ICONS.cross}</div></div>
      <div class="logo-text">
        <span id="sb-community">Emerge in Christ</span>
        <span>v3.0 · Multi-Extensions</span>
      </div>
    </div>
    <div class="sidebar-badge">
      <div class="ext-name" id="sb-ext-name">—</div>
      <div class="ext-role" id="sb-ext-role">—</div>
    </div>
    <nav class="sidebar-nav" id="sidebar-nav"></nav>
    <div class="sidebar-footer">
      <button class="btn-logout" onclick="doLogout()">⎋ Déconnexion</button>
    </div>
  </aside>
  <main id="main">
    <div id="topbar">
      <button class="menu-btn" onclick="toggleSidebar()">☰</button>
      <div>
        <div class="topbar-title" id="tb-title">—</div>
        <div class="topbar-sub" id="tb-sub">—</div>
      </div>
      <div class="topbar-right">
        <span class="topbar-badge" id="tb-badge">—</span>
      </div>
    </div>
    <div id="content"><div id="page"></div></div>
  </main>
</div>

<div id="modal-root"></div>
<div id="toast-wrap"></div>

<script>
'use strict';
// ═══════════════════════════════════════════════
// CONSTANTS & SEED DATA
// ═══════════════════════════════════════════════
const K={EXT:'eic_ext',RAP:'eic_rap',SES:'eic_ses',LOGO:'eic_logo',SET:'eic_set',SEED:'eic_seeded'};

const DEF_EXTS=[
  {id:'ext_nic',nom:'Nicosie Centre',couleur:'#8B5CF6',ville:'Nicosie',pays:'Chypre',adresse:'12 Avenue de la Paix, Nicosie',dateCreation:'2018-03-15',
   pasteur:{nom:'Pasteur Emmanuel Kabila',email:'e.kabila@eic.cy',tel:'+357 99 123 456'},
   coordinateur:'Frère David Mutombo',secretaire:'Sœur Rachel Lukusa',tresorier:'Frère Jean-Paul Ngoy',
   password:'nic123',devise:'EUR',symbole:'€'},
  {id:'ext_lim',nom:'Limassol Sud',couleur:'#059669',ville:'Limassol',pays:'Chypre',adresse:'45 Rue des Flamboyants, Limassol',dateCreation:'2019-07-20',
   pasteur:{nom:'Pasteur Pierre Kabasele',email:'p.kabasele@eic.cy',tel:'+357 99 654 321'},
   coordinateur:'Frère Samuel Banza',secretaire:'Sœur Esther Mwamba',tresorier:'Frère Isaac Tshimanga',
   password:'lim123',devise:'EUR',symbole:'€'},
  {id:'ext_lar',nom:'Larnaca Est',couleur:'#DC2626',ville:'Larnaca',pays:'Chypre',adresse:'8 Boulevard du Lac, Larnaca',dateCreation:'2020-01-10',
   pasteur:{nom:'Pasteur Daniel Nzamba',email:'d.nzamba@eic.cy',tel:'+357 99 789 012'},
   coordinateur:'Frère Caleb Mbombo',secretaire:'Sœur Miriam Kavula',tresorier:'Frère Thomas Luzolo',
   password:'lar123',devise:'EUR',symbole:'€'},
];

function seedIfNeeded(){
  if(localStorage.getItem(K.SEED)) return;
  localStorage.setItem(K.EXT, JSON.stringify(DEF_EXTS));
  const raps=[];
  DEF_EXTS.forEach(ext=>{
    [0,1,2,3,4].forEach(m=>{
      [5,12,19,26].forEach(day=>{
        const dt=new Date(2025,m,day);
        if(dt>new Date()) return;
        const pres=60+Math.floor(Math.random()*80);
        const tot=200+Math.floor(Math.random()*500);
        const dimes=Math.floor(tot*.3),ord=Math.floor(tot*.5),or=Math.floor(tot*.1),ag=tot-dimes-ord-or;
        const nCount=Math.floor(Math.random()*4);
        const dep=Math.floor(tot*.3);
        raps.push({
          id:`r_${ext.id}_${m}_${day}`,extensionId:ext.id,
          date:dt.toISOString().split('T')[0],heureDebut:'09:00',heureFin:'12:00',
          moderateur:ext.coordinateur,predicateur:ext.pasteur.nom,interprete:'',
          theme:'La Grâce de Dieu',textes:'Jean 3:16',
          effectif:{papas:Math.floor(pres*.2),mamans:Math.floor(pres*.25),freres:Math.floor(pres*.2),soeurs:Math.floor(pres*.25),enfants:Math.floor(pres*.1),total:pres},
          offrandes:{ordinaires:ord,orateur:or,dimes,actionsGrace:ag,total:tot},
          ventilation:{dixPctDime:+(dimes*.1).toFixed(2),dixPctSocial:+(tot*.1).toFixed(2),reste:+(tot*.8).toFixed(2)},
          depenses:[{motif:'Transport',montant:Math.floor(dep*.4)},{motif:'Collation',montant:Math.floor(dep*.3)},{motif:'Fournitures',montant:Math.floor(dep*.3)}],
          totalDepenses:dep,soldeFinal:tot-dep,
          nouveaux:Array.from({length:nCount},(_,i)=>({nom:`Nouveau ${i+1} (${ext.nom})`,tel:'+357 99 '+String(100000+Math.floor(Math.random()*900000))})),
          signatures:{secretaire:ext.secretaire,tresorier:ext.tresorier,pasteur:ext.pasteur.nom},
          updatedAt:new Date().toISOString()
        });
      });
    });
  });
  localStorage.setItem(K.RAP, JSON.stringify(raps));
  localStorage.setItem(K.SEED,'1');
}
seedIfNeeded();

// ═══════════════════════════════════════════════
// STORE
// ═══════════════════════════════════════════════
const Store={
  // Extensions
  getExts(){ try{return JSON.parse(localStorage.getItem(K.EXT))||DEF_EXTS;}catch{return DEF_EXTS;} },
  getExt(id){ return this.getExts().find(e=>e.id===id)||null; },
  saveExt(ext){ const a=this.getExts(); const i=a.findIndex(e=>e.id===ext.id); if(i>=0)a[i]=ext;else a.push(ext); localStorage.setItem(K.EXT,JSON.stringify(a)); },
  delExt(id){ localStorage.setItem(K.EXT,JSON.stringify(this.getExts().filter(e=>e.id!==id))); localStorage.setItem(K.RAP,JSON.stringify(this.getRaps().filter(r=>r.extensionId!==id))); },
  // Rapports
  getRaps(extId=null){ try{const a=JSON.parse(localStorage.getItem(K.RAP))||[];return extId?a.filter(r=>r.extensionId===extId):a;}catch{return[];} },
  getRap(id){ return this.getRaps().find(r=>r.id===id)||null; },
  saveRap(r){ const a=this.getRaps(); const i=a.findIndex(x=>x.id===r.id); r.updatedAt=new Date().toISOString(); if(i>=0)a[i]=r;else a.push(r); localStorage.setItem(K.RAP,JSON.stringify(a)); return r; },
  delRap(id){ localStorage.setItem(K.RAP,JSON.stringify(this.getRaps().filter(r=>r.id!==id))); },
  // Session
  getSes(){ try{return JSON.parse(localStorage.getItem(K.SES));}catch{return null;} },
  setSes(s){ localStorage.setItem(K.SES,JSON.stringify(s)); },
  clearSes(){ localStorage.removeItem(K.SES); },
  // Logo
  getLogo(){ return localStorage.getItem(K.LOGO)||null; },
  setLogo(d){ if(d)localStorage.setItem(K.LOGO,d);else localStorage.removeItem(K.LOGO); },
  // Settings
  getSet(){ try{return JSON.parse(localStorage.getItem(K.SET))||{nom:'Emerge in Christ',adminPw:'admin123'};}catch{return{nom:'Emerge in Christ',adminPw:'admin123'};} },
  saveSet(s){ localStorage.setItem(K.SET,JSON.stringify(s)); },
  // Analytics
  stats(extId=null){
    const a=this.getRaps(extId); const n=a.length;
    return{ cultes:n, presence:n?Math.round(a.reduce((s,r)=>s+(r.effectif?.total||0),0)/n):0,
      offrandes:a.reduce((s,r)=>s+(r.offrandes?.total||0),0), nouveaux:a.reduce((s,r)=>s+(r.nouveaux?.length||0),0) };
  },
  monthly(extId=null,yr=new Date().getFullYear()){
    const a=this.getRaps(extId).filter(r=>new Date(r.date+'T00:00').getFullYear()===yr);
    const m=Array.from({length:12},(_,i)=>({i,lbl:new Date(yr,i).toLocaleString('fr-FR',{month:'short'}),cultes:0,presence:0,offrandes:0,nouveaux:0}));
    a.forEach(r=>{ const mi=new Date(r.date+'T00:00').getMonth(); m[mi].cultes++; m[mi].presence+=r.effectif?.total||0; m[mi].offrandes+=r.offrandes?.total||0; m[mi].nouveaux+=r.nouveaux?.length||0; });
    return m;
  },
  allNouveaux(extId=null){
    const a=[];
    this.getRaps(extId).forEach(r=>(r.nouveaux||[]).forEach(n=>a.push({...n,date:r.date,extId:r.extensionId,rapId:r.id})));
    return a;
  },
};

// ═══════════════════════════════════════════════
// AUTH
// ═══════════════════════════════════════════════
const Auth={
  ses(){ return Store.getSes(); },
  isAdmin(){ const s=Store.getSes(); return s?.role==='admin'; },
  isExt(){ const s=Store.getSes(); return s?.role==='extension'; },
  loginAdmin(pw){ const cfg=Store.getSet(); if(pw===cfg.adminPw){Store.setSes({role:'admin'});return true;}return false; },
  loginExt(id,pw){ const e=Store.getExt(id); if(e&&e.password===pw){Store.setSes({role:'extension',extId:e.id});return true;}return false; },
  logout(){ Store.clearSes(); }
};

// ═══════════════════════════════════════════════
// UTILS
// ═══════════════════════════════════════════════
function fmt(v,sym=''){const n=parseFloat(v)||0;return sym+n.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2});}
function fmtD(d){if(!d)return'—';try{return new Date(d+'T00:00').toLocaleDateString('fr-FR',{day:'2-digit',month:'long',year:'numeric'});}catch{return d;}}
function uid(){return'r_'+Date.now()+'_'+Math.random().toString(36).slice(2,7);}
function mName(m){return new Date(2024,m).toLocaleString('fr-FR',{month:'long'});}
function hexRgb(h){if(!h||h.length<7)return[124,58,237];return[parseInt(h.slice(1,3),16),parseInt(h.slice(3,5),16),parseInt(h.slice(5,7),16)];}

const ICONS={
  dashboard:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>`,
  building:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><path d="M9 22v-4h6v4"/><path d="M8 6h.01"/><path d="M16 6h.01"/><path d="M12 6h.01"/><path d="M12 10h.01"/><path d="M12 14h.01"/><path d="M16 10h.01"/><path d="M16 14h.01"/><path d="M8 10h.01"/><path d="M8 14h.01"/></svg>`,
  fileText:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
  chartBar:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>`,
  users:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>`,
  settings:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>`,
  plus:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>`,
  mapPin:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-9 0 13a9 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>`,
  user:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
  mail:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>`,
  phone:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>`,
  handshake:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M8 11h8"/><path d="M8 15h8"/></svg>`,
  clipboard:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>`,
  wallet:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>`,
  trash:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`,
  eye:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`,
  file:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>`,
  save:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>`,
  download:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>`,
  upload:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>`,
  clock:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>`,
  userCheck:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><polyline points="17 11 19 13 23 9"/></svg>`,
  pen:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19l7-7l3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg>`,
  cross:`<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 5.41L18.59 4 7 15.59V9H5v10h10v-2H8.41z"/></svg>`,
  x:`<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>`,
  shield:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>`,
};
function ic(n){return ICONS[n]||ICONS.fileText;}

function toast(msg,type='success'){
  const w=document.getElementById('toast-wrap');
  const el=document.createElement('div');
  el.className=`toast t-${type}`;
  el.innerHTML=`<span>${type==='success'?'✓':'✕'}</span><span>${msg}</span>`;
  w.appendChild(el);
  setTimeout(()=>{el.style.animation='toastOut .3s ease forwards';setTimeout(()=>el.remove(),300);},3200);
}

// ═══════════════════════════════════════════════
// MODAL
// ═══════════════════════════════════════════════
function openModal(html,large=false){
  document.getElementById('modal-root').innerHTML=
    `<div class="modal-backdrop" onclick="if(event.target===this)closeModal()">
       <div class="modal${large?' modal-lg':''}">${html}</div>
     </div>`;
}
function closeModal(){document.getElementById('modal-root').innerHTML='';}

// ═══════════════════════════════════════════════
// ROUTER
// ═══════════════════════════════════════════════
const _routes={};
function regRoute(path,fn){_routes[path]=fn;}
function navTo(path,params={}){
  const q=Object.keys(params).length?'?'+new URLSearchParams(params).toString():'';
  window.location.hash=path+q;
}
function curPath(){return(window.location.hash.slice(1).split('?')[0])||'/';}
function curParams(){const[,q]=(window.location.hash.slice(1)).split('?');return q?Object.fromEntries(new URLSearchParams(q)):{};}
function initRouter(){
  const dispatch=()=>{const p=curPath();const fn=_routes[p]||_routes['*'];if(fn)fn(curParams());};
  window.addEventListener('hashchange',dispatch);
  dispatch();
}

// ═══════════════════════════════════════════════
// NAV
// ═══════════════════════════════════════════════
const ADMIN_NAV=[
  {g:'Général',items:[
    {icon:'dashboard',lbl:'Tableau de Bord',path:'/admin/dashboard'},
    {icon:'building',lbl:'Extensions',path:'/admin/extensions'},
    {icon:'fileText',lbl:'Tous les Rapports',path:'/admin/rapports'},
    {icon:'chartBar',lbl:'Bilans Comparatifs',path:'/admin/bilans'},
    {icon:'users',lbl:'Nouveaux Convertis',path:'/admin/convertis'},
  ]},
  {g:'Administration',items:[{icon:'settings',lbl:'Paramètres',path:'/admin/settings'}]},
];
const EXT_NAV=[
  {g:'Mon Extension',items:[
    {icon:'dashboard',lbl:'Tableau de Bord',path:'/ext/dashboard'},
    {icon:'plus',lbl:'Nouveau Rapport',path:'/ext/new'},
    {icon:'fileText',lbl:'Mes Rapports',path:'/ext/rapports'},
    {icon:'chartBar',lbl:'Bilans',path:'/ext/bilans'},
    {icon:'users',lbl:'Convertis',path:'/ext/convertis'},
  ]},
];

function buildNav(def){
  const nav=document.getElementById('sidebar-nav');
  nav.innerHTML=def.map(g=>`<div class="nav-group">${g.g}</div>${g.items.map(it=>`<button class="nav-item" data-path="${it.path}" onclick="navTo('${it.path}')"><span class="nav-icon">${ic(it.icon)}</span>${it.lbl}</button>`).join('')}`).join('');
}
function setActive(path){document.querySelectorAll('.nav-item').forEach(el=>el.classList.toggle('active',el.dataset.path===path));}
function setTopbar(title,sub,badge){
  document.getElementById('tb-title').textContent=title;
  document.getElementById('tb-sub').textContent=sub||'';
  document.getElementById('tb-badge').textContent=badge||'';
}
function render(html){document.getElementById('page').innerHTML=html;}

// ═══════════════════════════════════════════════
// LOGIN
// ═══════════════════════════════════════════════
window.switchTab=function(tab){
  document.querySelectorAll('.login-tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='extension'?0:1)));
  document.getElementById('panel-extension').classList.toggle('active',tab==='extension');
  document.getElementById('panel-admin').classList.toggle('active',tab==='admin');
};
window.doLogin=function(type){
  const err=document.getElementById('login-error');
  err.style.display='none';
  if(type==='admin'){
    const pw=document.getElementById('admin-pw').value;
    if(Auth.loginAdmin(pw)){startApp();}
    else{err.textContent='Mot de passe incorrect.';err.style.display='block';}
  }else{
    const id=document.getElementById('ext-select').value;
    const pw=document.getElementById('ext-pw').value;
    if(Auth.loginExt(id,pw)){startApp();}
    else{err.textContent='Extension ou mot de passe incorrect.';err.style.display='block';}
  }
};
window.doLogout=function(){Auth.logout();location.reload();};
window.toggleSidebar=function(){document.getElementById('sidebar').classList.toggle('open');};

function populateExtSel(){
  const sel=document.getElementById('ext-select');
  sel.innerHTML=Store.getExts().map(e=>`<option value="${e.id}">${e.nom} — ${e.ville}</option>`).join('');
}

// ═══════════════════════════════════════════════
// APP INIT
// ═══════════════════════════════════════════════
function updateLogoUI(){
  const logo=Store.getLogo();
  // Sidebar logo
  const wrap=document.getElementById('sb-logo-wrap');
  if(logo) wrap.innerHTML=`<div class="logo-img-wrap"><img src="${logo}" alt="logo"/></div>`;
  else wrap.innerHTML=`<div class="logo-placeholder">${ICONS.cross}</div>`;
  // Login logo
  const li=document.getElementById('login-icon');
  if(li){ if(logo)li.innerHTML=`<img src="${logo}" alt="logo"/>`;else li.innerHTML=ICONS.cross; }
  // Community name
  const cfg=Store.getSet();
  const sbn=document.getElementById('sb-community');
  if(sbn)sbn.textContent=cfg.nom||'Emerge in Christ';
}

function startApp(){
  updateLogoUI();
  document.getElementById('login-screen').style.display='none';
  document.getElementById('app').style.display='flex';
  const ses=Auth.ses();
  if(Auth.isAdmin()){
    document.getElementById('sb-ext-name').textContent='Administrateur Général';
    document.getElementById('sb-ext-role').textContent='Accès réseau complet';
    buildNav(ADMIN_NAV);
    registerAdminRoutes();
    initRouter();
    navTo('/admin/dashboard');
  }else{
    const ext=Store.getExt(ses.extId);
    document.getElementById('sb-ext-name').textContent=ext?.nom||'—';
    document.getElementById('sb-ext-role').textContent=ext?.ville||'—';
    buildNav(EXT_NAV);
    registerExtRoutes(ses.extId);
    initRouter();
    navTo('/ext/dashboard');
  }
}

// Check existing session
(function(){
  const s=Auth.ses();
  if(s){startApp();return;}
  populateExtSel();
  updateLogoUI();
})();

// ═══════════════════════════════════════════════
// SHARED COMPONENTS
// ═══════════════════════════════════════════════
function statCard(iconName,label,value,sub){
  return`<div class="stat-card"><div class="stat-label">${label}</div><div class="stat-value">${value}</div><div class="stat-sub">${sub}</div><div class="stat-icon">${ic(iconName)}</div></div>`;
}

function chartBar(id,labels,data,label,color){
  const ctx=document.getElementById(id)?.getContext('2d');
  if(!ctx)return;
  if(window._charts&&window._charts[id])window._charts[id].destroy();
  if(!window._charts)window._charts={};
  window._charts[id]=new Chart(ctx,{
    type:'bar',
    data:{labels,datasets:[{label,data,backgroundColor:color,borderRadius:5,borderSkipped:false}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#5A5280',font:{family:'DM Sans',size:10}},grid:{color:'rgba(90,82,128,.08)'}},
              y:{ticks:{color:'#5A5280',font:{family:'DM Sans',size:10}},grid:{color:'rgba(90,82,128,.08)'}}}}
  });
}

function chartLine(id,labels,datasets){
  const ctx=document.getElementById(id)?.getContext('2d');
  if(!ctx)return;
  if(window._charts&&window._charts[id])window._charts[id].destroy();
  if(!window._charts)window._charts={};
  window._charts[id]=new Chart(ctx,{
    type:'line',data:{labels,datasets:datasets.map(d=>({...d,tension:.4,fill:false}))},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#A199C4',font:{family:'DM Sans',size:11}}}},
      scales:{x:{ticks:{color:'#5A5280'}},y:{ticks:{color:'#5A5280'}}}}
  });
}

// ═══════════════════════════════════════════════
// ADMIN ROUTES
// ═══════════════════════════════════════════════
function registerAdminRoutes(){
  regRoute('/admin/dashboard',pgAdminDash);
  regRoute('/admin/extensions',pgAdminExts);
  regRoute('/admin/rapports',pgAdminRaps);
  regRoute('/admin/bilans',pgAdminBilans);
  regRoute('/admin/convertis',pgAdminConvertis);
  regRoute('/admin/settings',pgAdminSettings);
  regRoute('*',()=>navTo('/admin/dashboard'));
  window.addEventListener('hashchange',()=>setActive(curPath()));
}

// ---- Admin Dashboard ----
function pgAdminDash(){
  setActive('/admin/dashboard');
  const cfg=Store.getSet();
  const exts=Store.getExts();
  const st=Store.stats();
  const mo=Store.monthly(null,new Date().getFullYear());
  setTopbar('Tableau de Bord Global','Vue d\'ensemble du réseau','Admin');
  render(`
    <div class="page-header">
      <div><h1>Vue Générale</h1><p>${cfg.nom||'Emerge in Christ'} · ${exts.length} extension(s)</p></div>
      <button class="btn btn-secondary btn-sm" onclick="navTo('/admin/extensions')">${ICONS.settings} Gérer</button>
    </div>
    <div class="grid-4 mb-20">
      ${statCard('building','Extensions',exts.length,'Sites actifs')}
      ${statCard('users','Présence moy.',st.presence,'Par culte')}
      ${statCard('userCheck','Convertis',st.nouveaux,'Total réseau')}
    </div>
    <div class="grid-2 mb-20">
      <div class="card"><div class="form-section-title mb-12">Présence mensuelle ${new Date().getFullYear()}</div><div class="chart-wrap"><canvas id="chP"></canvas></div></div>
      <div class="card"><div class="form-section-title mb-12">Offrandes mensuelles ${new Date().getFullYear()}</div><div class="chart-wrap"><canvas id="chO"></canvas></div></div>
    </div>
    <div class="form-section-title mb-12">Performance par Extension</div>
    <div class="grid-3">
      ${exts.map(ext=>{
        const s=Store.stats(ext.id);
        const maxC=Math.max(1,...exts.map(e=>Store.stats(e.id).cultes));
        return`<div class="ext-card" style="--ext-color:${ext.couleur}">
          <div class="ext-card-name">${ext.nom}</div>
          <div class="ext-card-ville">${ICONS.mapPin} ${ext.ville}, ${ext.pays}</div>
          <div class="ext-mini-stats mb-12">
            <div><div class="ext-stat-val">${s.cultes}</div><div class="ext-stat-lbl">Cultes</div></div>
            <div><div class="ext-stat-val">${s.presence}</div><div class="ext-stat-lbl">Moy.</div></div>
            <div><div class="ext-stat-val">${s.nouveaux}</div><div class="ext-stat-lbl">Conv.</div></div>
          </div>
          <div class="text-xs text-muted mb-4">Activité relative</div>
          <div class="progress-bar"><div class="progress-fill" style="width:${Math.round(s.cultes/maxC*100)}%;background:${ext.couleur}"></div></div>
        </div>`;
      }).join('')}
    </div>
  `);
  const lb=mo.map(m=>m.lbl);
  chartBar('chP',lb,mo.map(m=>m.presence),'Présence','rgba(139,92,246,.7)');
  chartBar('chO',lb,mo.map(m=>m.offrandes),'Offrandes','rgba(245,158,11,.7)');
}

// ---- Admin Extensions ----
function pgAdminExts(){
  setActive('/admin/extensions');
  setTopbar('Extensions','Gestion du réseau','Admin');
  const exts=Store.getExts();
  render(`
    <div class="page-header">
      <div><h1>Extensions</h1><p>${exts.length} extension(s)</p></div>
      <button class="btn btn-primary" onclick="openExtForm(null)">${ICONS.plus} Nouvelle Extension</button>
    </div>
    <div class="grid-auto">${exts.map(extCard).join('')}</div>
  `);
}

function extCard(ext){
  const s=Store.stats(ext.id);
  return`<div class="ext-card" style="--ext-color:${ext.couleur}">
    <div class="flex justify-between items-center mb-8">
      <div><div class="ext-card-name">${ext.nom}</div><div class="ext-card-ville">${ICONS.mapPin} ${ext.ville}, ${ext.pays}</div></div>
      <div class="ext-card-pastor">
        ${ICONS.user} ${ext.pasteur?.nom||'—'}<br>${ICONS.mail} ${ext.pasteur?.email||'—'}<br>${ICONS.phone} ${ext.pasteur?.tel||'—'}
      </div>
      <div class="ext-card-team">
        ${ICONS.handshake} Coord: ${ext.coordinateur||'—'}<br>${ICONS.clipboard} Secrét: ${ext.secretaire||'—'}<br>${ICONS.wallet} Trésor: ${ext.tresorier||'—'}
      </div>
      <div class="flex gap-8">
        <button class="btn btn-secondary btn-sm" onclick="openExtForm('${ext.id}')">✏ Modifier</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDelExt('${ext.id}')">${ICONS.trash} Supprimer</button>
      </div>
    <div class="text-xs text-muted mb-8" style="line-height:1.8">
      ${ICONS.user} ${ext.pasteur?.nom||'—'}<br>${ICONS.mail} ${ext.pasteur?.email||'—'}<br>${ICONS.phone} ${ext.pasteur?.tel||'—'}
    </div>
    <div class="text-xs text-muted mb-12" style="line-height:1.8">
      ${ICONS.handshake} Coord: ${ext.coordinateur||'—'}<br>${ICONS.clipboard} Secrét: ${ext.secretaire||'—'}<br>${ICONS.wallet} Trésor: ${ext.tresorier||'—'}
    </div>
    <div class="ext-mini-stats mb-12">
      <div><div class="ext-stat-val">${s.cultes}</div><div class="ext-stat-lbl">Cultes</div></div>
      <div><div class="ext-stat-val">${s.presence}</div><div class="ext-stat-lbl">Moy.</div></div>
      <div><div class="ext-stat-val">${s.nouveaux}</div><div class="ext-stat-lbl">Conv.</div></div>
    </div>
    <div class="flex gap-8">
      <button class="btn btn-secondary btn-sm" onclick="openExtForm('${ext.id}')">✏ Modifier</button>
      <button class="btn btn-danger btn-sm" onclick="confirmDelExt('${ext.id}')">${ICONS.trash} Supprimer</button>
    </div>
  </div>`;
}

window.confirmDelExt=function(id){
  const ext=Store.getExt(id);
  if(!ext)return;
  openModal(`<div class="modal-header"><h2>Supprimer l'extension</h2><button class="modal-close" onclick="closeModal()">${ICONS.x}</button></div>
    <div class="modal-body"><p style="color:var(--text2)">Supprimer <strong style="color:var(--text)">${ext.nom}</strong> et tous ses rapports ? Action irréversible.</p></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn btn-danger" onclick="closeModal();Store.delExt('${id}');toast('Extension supprimée','success');pgAdminExts()">Confirmer</button>
    </div>`);
};

const DEVISES=[
  {c:'EUR',s:'€'},{c:'USD',s:'$'},{c:'GBP',s:'£'},{c:'CDF',s:'FC'},{c:'XAF',s:'FCFA'},
  {c:'XOF',s:'CFA'},{c:'NGN',s:'₦'},{c:'ZAR',s:'R'},{c:'KES',s:'KSh'},{c:'GHS',s:'GH₵'},
  {c:'TZS',s:'TSh'},{c:'UGX',s:'USh'},{c:'RWF',s:'RF'},{c:'CHF',s:'CHF'},{c:'CAD',s:'CA$'},
];

window.openExtForm=function(extId){
  const e=extId?Store.getExt(extId):{};
  const isEdit=!!extId;
  openModal(`
    <div class="modal-header"><h2>${isEdit?'Modifier':'Nouvelle'} Extension</h2><button class="modal-close" onclick="closeModal()">${ICONS.x}</button></div>
    <div class="modal-body">
      <div class="form-section-title mb-12">Identité</div>
      <div class="form-row cols-2">
        <div><label>Nom de l'extension *</label><input id="ef-nom" value="${e.nom||''}"/></div>
        <div><label>Date de création</label><input id="ef-date" type="date" value="${e.dateCreation||''}"/></div>
      </div>
      <div class="form-row cols-3">
        <div><label>Couleur</label><input id="ef-col" type="color" value="${e.couleur||'#8B5CF6'}"/></div>
        <div><label>Devise</label><select id="ef-dev" onchange="onDevChange()">
          ${DEVISES.map(d=>`<option value="${d.c}" data-s="${d.s}" ${e.devise===d.c?'selected':''}>${d.c} — ${d.s}</option>`).join('')}
        </select></div>
        <div><label>Symbole</label><input id="ef-sym" value="${e.symbole||'€'}" placeholder="€"/></div>
      </div>
      <div class="form-section-title mb-12">Localisation</div>
      <div class="form-row"><label>Adresse complète</label><input id="ef-addr" value="${e.adresse||''}"/></div>
      <div class="form-row cols-2">
        <div><label>Ville</label><input id="ef-ville" value="${e.ville||''}"/></div>
        <div><label>Pays</label><input id="ef-pays" value="${e.pays||''}"/></div>
      </div>
      <div class="form-section-title mb-12">Équipe Pastorale</div>
      <div class="form-row cols-2">
        <div><label>Pasteur Principal</label><input id="ef-past" value="${e.pasteur?.nom||''}"/></div>
        <div><label>Email du Pasteur</label><input id="ef-email" type="email" value="${e.pasteur?.email||''}"/></div>
      </div>
      <div class="form-row cols-2">
        <div><label>Téléphone</label><input id="ef-tel" value="${e.pasteur?.tel||''}"/></div>
        <div><label>Coordinateur</label><input id="ef-coord" value="${e.coordinateur||''}"/></div>
      </div>
      <div class="form-row cols-2">
        <div><label>Secrétaire</label><input id="ef-sec" value="${e.secretaire||''}"/></div>
        <div><label>Trésorier</label><input id="ef-tres" value="${e.tresorier||''}"/></div>
      </div>
      <div class="form-section-title mb-12">Accès</div>
      <div class="form-row cols-2">
        <div><label>Mot de passe *</label><input id="ef-pw" value="${e.password||''}"/></div>
        <div></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn btn-primary" onclick="saveExtForm('${extId||''}')">${ICONS.save} Enregistrer</button>
    </div>`,true);
};
window.onDevChange=function(){
  const sel=document.getElementById('ef-dev');
  const opt=sel.options[sel.selectedIndex];
  const sym=document.getElementById('ef-sym');
  if(sym&&opt)sym.value=opt.dataset.s||'';
};
window.saveExtForm=function(extId){
  const g=id=>document.getElementById(id)?.value?.trim()||'';
  const nom=g('ef-nom'); if(!nom){toast('Le nom est obligatoire','error');return;}
  const pw=g('ef-pw'); if(!pw){toast('Mot de passe obligatoire','error');return;}
  const ext={
    id:extId||'ext_'+Date.now(),
    nom,dateCreation:g('ef-date'),couleur:g('ef-col')||'#8B5CF6',
    devise:document.getElementById('ef-dev')?.value||'EUR',symbole:g('ef-sym')||'€',
    adresse:g('ef-addr'),ville:g('ef-ville'),pays:g('ef-pays'),
    pasteur:{nom:g('ef-past'),email:g('ef-email'),tel:g('ef-tel')},
    coordinateur:g('ef-coord'),secretaire:g('ef-sec'),tresorier:g('ef-tres'),
    password:pw,
  };
  Store.saveExt(ext);
  closeModal();
  toast(`Extension "${nom}" enregistrée`,'success');
  pgAdminExts();
};

// ---- Admin Rapports ----
function pgAdminRaps(params={}){
  setActive('/admin/rapports');
  setTopbar('Tous les Rapports','Réseau complet','Admin');
  const exts=Store.getExts();
  const fExt=params.ext||'';
  const fMonth=params.month!==undefined&&params.month!==''?parseInt(params.month):-1;
  const fYear=params.year?parseInt(params.year):0;

  let raps=Store.getRaps(fExt||null);
  if(fMonth>=0) raps=raps.filter(r=>new Date(r.date+'T00:00').getMonth()===fMonth);
  if(fYear) raps=raps.filter(r=>new Date(r.date+'T00:00').getFullYear()===fYear);
  raps.sort((a,b)=>b.date.localeCompare(a.date));

  render(`
    <div class="page-header">
      <div><h1>Rapports de Culte</h1><p>${raps.length} rapport(s)</p></div>
    </div>
    <div class="filter-bar">
      <select onchange="adminRapFilter(this,'ext')">
        <option value="">— Toutes les extensions —</option>
        ${exts.map(e=>`<option value="${e.id}"${fExt===e.id?' selected':''}>${e.nom}</option>`).join('')}
      </select>
      <select onchange="adminRapFilter(this,'month')">
        <option value="">— Tous les mois —</option>
        ${Array.from({length:12},(_,i)=>`<option value="${i}"${fMonth===i?' selected':''}>${mName(i)}</option>`).join('')}
      </select>
      <select onchange="adminRapFilter(this,'year')">
        <option value="">— Toutes années —</option>
        ${[2025,2024,2023].map(y=>`<option value="${y}"${fYear===y?' selected':''}>${y}</option>`).join('')}
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Extension</th><th>Modérateur</th><th>Présence</th><th>Offrandes</th><th>Convertis</th><th>Actions</th></tr></thead>
        <tbody>
          ${raps.length===0?`<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--text3)">Aucun rapport trouvé</td></tr>`:''}
          ${raps.map(r=>{
            const ext=Store.getExt(r.extensionId);
            return`<tr>
              <td class="td-bold">${fmtD(r.date)}</td>
              <td><span class="badge" style="background:${ext?.couleur||'#8B5CF6'}22;color:${ext?.couleur||'#8B5CF6'};border:1px solid ${ext?.couleur||'#8B5CF6'}44">${ext?.nom||'—'}</span></td>
              <td>${r.moderateur||'—'}</td>
              <td>${r.effectif?.total||0}</td>
              <td>${fmt(r.offrandes?.total,ext?.symbole||'€')}</td>
              <td>${r.nouveaux?.length||0}</td>
              <td>
                <div class="flex gap-8">
                  <button class="btn btn-secondary btn-sm btn-icon" onclick="showRapModal('${r.id}')" title="Voir">${ICONS.eye}</button>
                  <button class="btn btn-gold btn-sm btn-icon" onclick="doExportPDF('${r.id}')" title="PDF">${ICONS.file}</button>
                  <button class="btn btn-success btn-sm btn-icon" onclick="doExportDOCX('${r.id}')" title="DOCX">${ICONS.pen}</button>
                </div>
              </td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`);
}
window.adminRapFilter=function(sel,field){
  const p=curParams();
  if(sel.value!=='')p[field]=sel.value;else delete p[field];
  navTo('/admin/rapports',p);
};

// ---- Admin Bilans ----
function pgAdminBilans(){
  setActive('/admin/bilans');
  setTopbar('Bilans Comparatifs','Analyse et synthèse','Admin');
  const exts=Store.getExts();
  const yr=new Date().getFullYear();
  const mo=Store.monthly(null,yr);
  render(`
    <div class="page-header">
      <div><h1>Bilans Comparatifs</h1><p>${exts.length} extensions · ${yr}</p></div>
    </div>
    <div class="grid-3 mb-20">
      ${exts.map(ext=>{
        const s=Store.stats(ext.id);
        return`<div class="card" style="border-left:3px solid ${ext.couleur}">
          <div class="flex justify-between items-center mb-12">
            <div class="font-bold">${ext.nom}</div>
            <span class="badge badge-purple">${ext.symbole}</span>
          </div>
          <div class="calc-box">
            <div class="calc-row"><span>Cultes</span><span>${s.cultes}</span></div>
            <div class="calc-row"><span>Présence moy.</span><span>${s.presence}</span></div>
            <div class="calc-row"><span>Offrandes</span><span>${fmt(s.offrandes,ext.symbole)}</span></div>
            <div class="calc-row total-row"><span>Convertis</span><span>${s.nouveaux}</span></div>
          </div>
        </div>`;
      }).join('')}
    </div>
    <div class="card mb-20">
      <div class="form-section-title mb-12">Présence comparative par mois (${yr})</div>
      <div class="chart-wrap" style="height:260px"><canvas id="chCmp"></canvas></div>
    </div>
    <div class="form-section-title mb-12">Tableau comparatif mensuel</div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Mois</th>${exts.map(e=>`<th>${e.nom}</th>`).join('')}<th>Total</th></tr></thead>
        <tbody>
          ${mo.map(m=>{
            const vals=exts.map(ext=>Store.monthly(ext.id,yr)[m.i].presence);
            const tot=vals.reduce((a,b)=>a+b,0);
            return`<tr><td class="td-bold">${m.lbl} ${yr}</td>${vals.map(v=>`<td>${v||0}</td>`).join('')}<td class="td-bold">${tot}</td></tr>`;
          }).join('')}
        </tbody>
      </table>
    </div>`);
  chartLine('chCmp',mo.map(m=>m.lbl),exts.map(ext=>{
    const d=Store.monthly(ext.id,yr);
    return{label:ext.nom,data:d.map(m=>m.presence),borderColor:ext.couleur,backgroundColor:ext.couleur+'30'};
  }));
}

// ---- Admin Convertis ----
function pgAdminConvertis(){
  setActive('/admin/convertis');
  setTopbar('Nouveaux Convertis','Réseau complet','Admin');
  const all=Store.allNouveaux().sort((a,b)=>b.date.localeCompare(a.date));
  render(`
    <div class="page-header"><div><h1>Nouveaux Convertis</h1><p>${all.length} au total dans le réseau</p></div></div>
    <div class="filter-bar">
      <input id="conv-q" type="text" placeholder="🔍 Rechercher par nom..." oninput="filterConv()" style="max-width:260px"/>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Nom</th><th>Téléphone</th><th>Extension</th><th>Date</th></tr></thead>
        <tbody id="conv-body">
          ${all.map(n=>{
            const ext=Store.getExt(n.extId);
            return`<tr data-name="${(n.nom||'').toLowerCase()}">
              <td class="td-bold">${n.nom||'—'}</td>
              <td>${n.tel||'—'}</td>
              <td><span class="badge" style="background:${ext?.couleur||'#8B5CF6'}22;color:${ext?.couleur||'#8B5CF6'}">${ext?.nom||'—'}</span></td>
              <td>${fmtD(n.date)}</td>
            </tr>`;
          }).join('')}
          ${all.length===0?`<tr><td colspan="4" style="text-align:center;padding:32px;color:var(--text3)">Aucun converti enregistré</td></tr>`:''}
        </tbody>
      </table>
    </div>`);
}
window.filterConv=function(){
  const q=(document.getElementById('conv-q')?.value||'').toLowerCase();
  document.querySelectorAll('#conv-body tr[data-name]').forEach(r=>r.style.display=(r.dataset.name||'').includes(q)?'':'none');
};

// ---- Admin Settings ----
function pgAdminSettings(){
  setActive('/admin/settings');
  setTopbar('Paramètres','Configuration','Admin');
  const cfg=Store.getSet();
  const logo=Store.getLogo();
  render(`
    <div class="page-header"><h1>Paramètres Généraux</h1></div>
    <div class="grid-2">
      <div class="card">
        <div class="form-section-title mb-12">Communauté</div>
        <div class="form-row"><label>Nom de la communauté</label><input id="s-nom" value="${cfg.nom||'Emerge in Christ'}"/></div>
        <div class="form-row mt-8"><label>Mot de passe administrateur</label><input id="s-pw" type="text" value="${cfg.adminPw||'admin123'}"/></div>
        <button class="btn btn-primary mt-16" onclick="saveSettings()">${ICONS.save} Enregistrer</button>
      </div>
      <div class="card">
        <div class="form-section-title mb-12">Logo de la Communauté</div>
        ${logo?`<div class="mb-12"><img src="${logo}" style="width:80px;height:80px;border-radius:12px;object-fit:cover;border:2px solid var(--accent)"/></div>`:
          '<p class="text-muted text-sm mb-12">Aucun logo configuré</p>'}
        <div class="form-row"><label>Importer (PNG, JPG, SVG)</label><input type="file" id="logo-file" accept="image/*" onchange="uploadLogo(this)"/></div>
        ${logo?`<button class="btn btn-danger btn-sm mt-8" onclick="removeLogo()">${ICONS.trash} Supprimer le logo</button>`:''}
      </div>
    </div>`);
}
window.saveSettings=function(){
  Store.saveSet({nom:document.getElementById('s-nom').value.trim()||'Emerge in Christ',adminPw:document.getElementById('s-pw').value.trim()||'admin123'});
  updateLogoUI();
  toast('Paramètres enregistrés','success');
};
window.uploadLogo=function(input){
  const f=input.files[0]; if(!f)return;
  const r=new FileReader();
  r.onload=e=>{Store.setLogo(e.target.result);updateLogoUI();toast('Logo importé','success');pgAdminSettings();};
  r.readAsDataURL(f);
};
window.removeLogo=function(){Store.setLogo(null);updateLogoUI();toast('Logo supprimé','success');pgAdminSettings();};

// ═══════════════════════════════════════════════
// EXTENSION ROUTES
// ═══════════════════════════════════════════════
function registerExtRoutes(extId){
  regRoute('/ext/dashboard',()=>pgExtDash(extId));
  regRoute('/ext/new',()=>pgRapportForm(extId,null));
  regRoute('/ext/edit',(p)=>pgRapportForm(extId,p.id));
  regRoute('/ext/rapports',()=>pgExtRaps(extId));
  regRoute('/ext/bilans',()=>pgExtBilans(extId));
  regRoute('/ext/convertis',()=>pgExtConvertis(extId));
  regRoute('*',()=>navTo('/ext/dashboard'));
  window.addEventListener('hashchange',()=>setActive(curPath()));
}

function pgExtDash(extId){
  setActive('/ext/dashboard');
  const ext=Store.getExt(extId);
  if(!ext){toast('Extension introuvable','error');return;}
  setTopbar(ext.nom,ext.ville+' · '+ext.pays,ext.devise);
  const st=Store.stats(extId);
  const mo=Store.monthly(extId,new Date().getFullYear());
  const raps=Store.getRaps(extId).sort((a,b)=>b.date.localeCompare(a.date));
  const sym=ext.symbole||'€';
  render(`
    <div class="page-header">
      <div><h1>${ext.nom}</h1><p>${ICONS.mapPin} ${ext.adresse} · ${ext.pasteur?.nom}</p></div>
      <button class="btn btn-primary" onclick="navTo('/ext/new')">${ICONS.plus} Nouveau Rapport</button>
    </div>
    <div class="grid-4 mb-20">
      ${statCard('📋','Cultes',st.cultes,'Total')}
      ${statCard('users','Présence moy.',st.presence,'Par culte')}
      ${statCard('wallet','Offrandes',fmt(st.offrandes,sym),'Total')}
      ${statCard('userCheck','Convertis',st.nouveaux,'Total')}
    </div>
    <div class="grid-2 mb-20">
      <div class="card"><div class="form-section-title mb-12">Présence mensuelle ${new Date().getFullYear()}</div><div class="chart-wrap"><canvas id="chP"></canvas></div></div>
      <div class="card"><div class="form-section-title mb-12">Offrandes mensuelles ${new Date().getFullYear()}</div><div class="chart-wrap"><canvas id="chO"></canvas></div></div>
    </div>
    <div class="flex justify-between items-center mb-12">
      <div class="form-section-title" style="margin:0">Derniers Rapports</div>
      <button class="btn btn-secondary btn-sm" onclick="navTo('/ext/rapports')">Voir tous →</button>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Prédicateur</th><th>Présence</th><th>Offrandes</th><th>Convertis</th><th>Actions</th></tr></thead>
        <tbody>
          ${raps.length===0?`<tr><td colspan="6" style="text-align:center;padding:28px;color:var(--text3)">Aucun rapport. <button class="btn btn-primary btn-sm" onclick="navTo('/ext/new')">Créer le premier</button></td></tr>`:''}
          ${raps.slice(0,6).map(r=>`<tr>
            <td class="td-bold">${fmtD(r.date)}</td><td>${r.predicateur||'—'}</td>
            <td>${r.effectif?.total||0}</td><td>${fmt(r.offrandes?.total,sym)}</td>
            <td>${r.nouveaux?.length||0}</td>
            <td><div class="flex gap-8">
              <button class="btn btn-secondary btn-sm btn-icon" onclick="showRapModal('${r.id}')" title="Voir">${ICONS.eye}</button>
              <button class="btn btn-gold btn-sm btn-icon" onclick="doExportPDF('${r.id}')" title="PDF">${ICONS.file}</button>
              <button class="btn btn-primary" onclick="navTo('/ext/new')">${ICONS.plus} Nouveau</button>
    </div>
    <div class="filter-bar">
      <input id="rap-q" type="text" placeholder="🔍 Rechercher..." oninput="filterTable('rap-q','rap-body')" style="max-width:220px"/>
      <select onchange="filterMonth(this,'rap-body')">
        <option value="">— Tous les mois —</option>
        ${Array.from({length:12},(_,i)=>`<option value="${i}">${mName(i)}</option>`).join('')}
      </select>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Date</th><th>Modérateur</th><th>Prédicateur</th><th>Présence</th><th>Offrandes</th><th>Convertis</th><th>Actions</th></tr></thead>
        <tbody id="rap-body">
          ${raps.map(r=>`<tr data-text="${(r.date+r.moderateur+r.predicateur+r.theme).toLowerCase()}" data-month="${new Date(r.date+'T00:00').getMonth()}">
            <td class="td-bold">${fmtD(r.date)}</td>
            <td>${r.moderateur||'—'}</td><td>${r.predicateur||'—'}</td>
            <td>${r.effectif?.total||0}</td><td>${fmt(r.offrandes?.total,sym)}</td>
            <td>${r.nouveaux?.length||0}</td>
            <td><div class="flex gap-8">
              <button class="btn btn-secondary btn-sm btn-icon" onclick="showRapModal('${r.id}')" title="Voir">${ICONS.eye}</button>
              <button class="btn btn-gold btn-sm btn-icon" onclick="doExportPDF('${r.id}')" title="PDF">${ICONS.file}</button>
              <button class="btn btn-success btn-sm btn-icon" onclick="doExportDOCX('${r.id}')" title="DOCX">${ICONS.pen}</button>
              <button class="btn btn-danger btn-sm btn-icon" onclick="confirmDelRap('${r.id}','${extId}')" title="Supprimer">${ICONS.trash}</button>
            </div></td>
          </tr>`).join('')}
          ${raps.length===0?`<tr><td colspan="7" style="text-align:center;padding:32px;color:var(--text3)">Aucun rapport</td></tr>`:''}
        </tbody>
      </table>
    </div>`);
}

window.confirmDelRap=function(id,extId){
  openModal(`<div class="modal-header"><h2>Supprimer le rapport</h2><button class="modal-close" onclick="closeModal()">${ICONS.x}</button></div>
    <div class="modal-body"><p style="color:var(--text2)">Supprimer ce rapport ? Action irréversible.</p></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
      <button class="btn btn-danger" onclick="closeModal();Store.delRap('${id}');toast('Rapport supprimé','success');pgExtRaps('${extId}')">Confirmer</button>
    </div>`);
};

function pgExtBilans(extId){
  setActive('/ext/bilans');
  const ext=Store.getExt(extId);
  setTopbar('Bilans Périodiques','Analyse de votre extension',ext?.nom||'—');
  const yr=new Date().getFullYear();
  const mo_cur=new Date().getMonth();
  const sym=ext?.symbole||'€';
  const monthly=Store.monthly(extId,yr);

  function bilanStats(type){
    const raps=Store.getRaps(extId).filter(r=>{
      const d=new Date(r.date+'T00:00');
      if(d.getFullYear()!==yr) return false;
      if(type==='mensuel') return d.getMonth()===mo_cur;
      if(type==='trimestriel') return Math.floor(d.getMonth()/3)===Math.floor(mo_cur/3);
      return true;
    });
    return{n:raps.length,pres:raps.reduce((s,r)=>s+(r.effectif?.total||0),0),
      off:raps.reduce((s,r)=>s+(r.offrandes?.total||0),0),
      dep:raps.reduce((s,r)=>s+(r.totalDepenses||0),0),
      nouv:raps.reduce((s,r)=>s+(r.nouveaux?.length||0),0)};
  }

  function bilanCard(title,period,type,st){
    const extIdEncoded=extId;
    return`<div class="card">
      <div class="flex justify-between items-center mb-12">
        <div><div class="font-bold">${title}</div><div class="text-xs text-muted">${period}</div></div>
        <button class="btn btn-gold btn-sm" onclick="doExportBilanPDF('${type}','${extIdEncoded}',${yr},${mo_cur})">${ICONS.file} PDF</button>
      </div>
      <div class="calc-box">
        <div class="calc-row"><span>Cultes</span><span>${st.n}</span></div>
        <div class="calc-row"><span>Présence totale</span><span>${st.pres}</span></div>
        <div class="calc-row"><span>Offrandes</span><span>${fmt(st.off,sym)}</span></div>
        <div class="calc-row"><span>Dépenses</span><span>${fmt(st.dep,sym)}</span></div>
        <div class="calc-row total-row"><span>Solde net</span><span>${fmt(st.off-st.dep,sym)}</span></div>
      </div>
      <div class="text-xs text-muted mt-8">${ICONS.userCheck} ${st.nouv} nouveau(x) converti(s)</div>
    </div>`;
  }

  render(`
    <div class="page-header"><div><h1>Bilans Périodiques</h1><p>${ext?.nom} · ${yr}</p></div></div>
    <div class="grid-3 mb-20">
      ${bilanCard('Bilan Mensuel',mName(mo_cur)+' '+yr,'mensuel',bilanStats('mensuel'))}
      ${bilanCard('Bilan Trimestriel','T'+(Math.floor(mo_cur/3)+1)+' '+yr,'trimestriel',bilanStats('trimestriel'))}
      ${bilanCard('Bilan Annuel','Année '+yr,'annuel',bilanStats('annuel'))}
    </div>
    <div class="card">
      <div class="form-section-title mb-12">Évolution mensuelle ${yr}</div>
      <div class="chart-wrap" style="height:260px"><canvas id="chBil"></canvas></div>
    </div>`);

  const lb=monthly.map(m=>m.lbl);
  if(window._charts?.chBil)window._charts.chBil.destroy();
  if(!window._charts)window._charts={};
  window._charts.chBil=new Chart(document.getElementById('chBil').getContext('2d'),{
    type:'bar',
    data:{labels:lb,datasets:[
      {label:'Présence',data:monthly.map(m=>m.presence),backgroundColor:'rgba(139,92,246,.6)',borderRadius:5},
      {label:`Offrandes ${sym}`,data:monthly.map(m=>m.offrandes),backgroundColor:'rgba(245,158,11,.6)',borderRadius:5},
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#A199C4',font:{family:'DM Sans'}}}},
      scales:{x:{ticks:{color:'#5A5280'}},y:{ticks:{color:'#5A5280'}}}}
  });
}

function pgExtConvertis(extId){
  setActive('/ext/convertis');
  const ext=Store.getExt(extId);
  setTopbar('Nouveaux Convertis','Suivi des âmes',ext?.nom||'—');
  const all=Store.allNouveaux(extId).sort((a,b)=>b.date.localeCompare(a.date));
  render(`
    <div class="page-header"><div><h1>Nouveaux Convertis</h1><p>${all.length} au total</p></div></div>
    <div class="filter-bar">
      <input id="conv-q" type="text" placeholder="🔍 Rechercher par nom..." oninput="filterConv()" style="max-width:260px"/>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Nom</th><th>Téléphone</th><th>Date du Culte</th></tr></thead>
        <tbody id="conv-body">
          ${all.map(n=>`<tr data-name="${(n.nom||'').toLowerCase()}"><td class="td-bold">${n.nom||'—'}</td><td>${n.tel||'—'}</td><td>${fmtD(n.date)}</td></tr>`).join('')}
          ${all.length===0?`<tr><td colspan="3" style="text-align:center;padding:32px;color:var(--text3)">Aucun converti enregistré</td></tr>`:''}
        </tbody>
      </table>
    </div>`);
}

// filter helpers
window.filterTable=function(inputId,bodyId){
  const q=(document.getElementById(inputId)?.value||'').toLowerCase();
  document.querySelectorAll(`#${bodyId} tr[data-text]`).forEach(r=>r.style.display=(r.dataset.text||'').includes(q)?'':'none');
};
window.filterMonth=function(sel,bodyId){
  const v=sel.value;
  document.querySelectorAll(`#${bodyId} tr[data-month]`).forEach(r=>r.style.display=(!v||r.dataset.month===v)?'':'none');
};

// ═══════════════════════════════════════════════
// RAPPORT FORM (Step-by-step)
// ═══════════════════════════════════════════════
const STEPS=['Culte','Effectif','Offrandes','Dépenses','Convertis','Signature'];
let _rap={};      // current rapport being edited
let _step=0;      // current step
let _extId='';    // current extension id

function pgRapportForm(extId,rapportId){
  _extId=extId;
  const isEdit=!!rapportId;
  setActive(isEdit?'/ext/rapports':'/ext/new');
  const ext=Store.getExt(extId);
  if(!ext){toast('Extension introuvable','error');return;}
  const sym=ext.symbole||'€';
  setTopbar(isEdit?'Modifier Rapport':'Nouveau Rapport','Formulaire étape par étape',ext.nom);

  if(isEdit && rapportId){
    const saved=Store.getRap(rapportId);
    if(!saved){toast('Rapport introuvable','error');navTo('/ext/rapports');return;}
    _rap=JSON.parse(JSON.stringify(saved)); // deep clone
  }else{
    _rap={
      id:uid(),extensionId:extId,
      date:new Date().toISOString().split('T')[0],
      heureDebut:'09:00',heureFin:'12:00',
      moderateur:ext.coordinateur||'',predicateur:ext.pasteur?.nom||'',
      interprete:'',theme:'',textes:'',
      effectif:{papas:0,mamans:0,freres:0,soeurs:0,enfants:0,total:0},
      offrandes:{ordinaires:0,orateur:0,dimes:0,actionsGrace:0,total:0},
      ventilation:{dixPctDime:0,dixPctSocial:0,reste:0},
      depenses:[],totalDepenses:0,soldeFinal:0,
      nouveaux:[],
      signatures:{secretaire:ext.secretaire||'',tresorier:ext.tresorier||'',pasteur:ext.pasteur?.nom||''}
    };
  }
  _step=0;
  renderRapportPage();
}

function renderRapportPage(){
  const ext=Store.getExt(_extId);
  render(`
    <div class="page-header">
      <div><h1>${_rap.id&&Store.getRap(_rap.id)?'Modifier le':'Nouveau'} Rapport</h1><p>${ext?.nom} · ${fmtD(_rap.date)}</p></div>
      <button class="btn btn-secondary" onclick="navTo('/ext/rapports')">← Retour</button>
    </div>
    <div class="stepper">${buildStepper()}</div>
    <div id="step-body">${buildStep(_step)}</div>
    <div class="flex justify-between mt-20" id="step-btns">
      ${_step>0?`<button class="btn btn-secondary" onclick="goPrevStep()">← Précédent</button>`:'<div></div>'}
      ${_step<STEPS.length-1?`<button class="btn btn-primary" onclick="goNextStep()">Suivant →</button>`:''}
    </div>`);
}

function buildStepper(){
  return STEPS.map((s,i)=>{
    const cls=i<_step?'s-done':i===_step?'s-active':'';
    const icon=i<_step?'✓':String(i+1);
    return`<div class="step-item">
      <div class="step-dot ${cls}" onclick="jumpStep(${i})">${icon}</div>
      <span class="step-lbl ${i===_step?'s-active':''}">${s}</span>
      ${i<STEPS.length-1?'<div class="step-connector"></div>':''}
    </div>`;
  }).join('');
}

function buildStep(step){
  const ext=Store.getExt(_extId);
  const sym=ext?.symbole||'€';
  const r=_rap;
  switch(step){
    case 0: return`<div class="card">
      <div class="form-section-title mb-12">Informations du Culte</div>
      <div class="form-row cols-3">
        <div><label>Date *</label><input id="s-date" type="date" value="${r.date||''}"/></div>
        <div><label>Heure début</label><input id="s-hd" type="time" value="${r.heureDebut||'09:00'}"/></div>
        <div><label>Heure fin</label><input id="s-hf" type="time" value="${r.heureFin||'12:00'}"/></div>
      </div>
      <div class="form-row cols-2">
        <div><label>Modérateur</label><input id="s-mod" value="${esc(r.moderateur)}"/></div>
        <div><label>Prédicateur</label><input id="s-pred" value="${esc(r.predicateur)}"/></div>
      </div>
      <div class="form-row cols-2">
        <div><label>Interprète</label><input id="s-interp" value="${esc(r.interprete)}"/></div>
        <div><label>Textes bibliques</label><input id="s-tex" value="${esc(r.textes)}"/></div>
      </div>
      <div class="form-row"><label>Thème</label><input id="s-theme" value="${esc(r.theme)}"/></div>
    </div>`;

    case 1: return`<div class="card">
      <div class="form-section-title mb-12">Effectif du Culte</div>
      <div class="form-row cols-5">
        ${['papas','mamans','freres','soeurs','enfants'].map((k,i)=>`<div><label>${['Papas','Mamans','Frères','Sœurs','Enfants'][i]}</label><input id="eff-${k}" type="number" min="0" value="${r.effectif?.[k]||0}" oninput="recalcEff()"/></div>`).join('')}
      </div>
      <div class="total-box mt-12"><span class="total-box-label">Total présence</span><span class="total-box-value" id="eff-total">${r.effectif?.total||0} personnes</span></div>
    </div>`;

    case 2: return`<div class="card">
      <div class="form-section-title mb-12">Offrandes (${sym})</div>
      <div class="form-row cols-2">
        <div><label>Ordinaires</label><input id="off-ord" type="number" min="0" step="0.01" value="${r.offrandes?.ordinaires||0}" oninput="recalcOff()"/></div>
        <div><label>Orateur</label><input id="off-or" type="number" min="0" step="0.01" value="${r.offrandes?.orateur||0}" oninput="recalcOff()"/></div>
      </div>
      <div class="form-row cols-2">
        <div><label>Dîmes</label><input id="off-dim" type="number" min="0" step="0.01" value="${r.offrandes?.dimes||0}" oninput="recalcOff()"/></div>
        <div><label>Actions de Grâce</label><input id="off-ag" type="number" min="0" step="0.01" value="${r.offrandes?.actionsGrace||0}" oninput="recalcOff()"/></div>
      </div>
      <div class="total-box mt-12"><span class="total-box-label">Total offrandes</span><span class="total-box-value" id="off-total">${fmt(r.offrandes?.total,sym)}</span></div>
      <div class="calc-box mt-12" id="vent-box">
        <div class="calc-row"><span>10% Dîmes (local)</span><span id="v-dime">${fmt(r.ventilation?.dixPctDime,sym)}</span></div>
        <div class="calc-row"><span>10% Social</span><span id="v-soc">${fmt(r.ventilation?.dixPctSocial,sym)}</span></div>
        <div class="calc-row total-row"><span>Reste</span><span id="v-reste">${fmt(r.ventilation?.reste,sym)}</span></div>
      </div>
    </div>`;

    case 3: return`<div class="card">
      <div class="form-section-title mb-12">Dépenses (${sym})</div>
      <div id="dep-list">${(r.depenses||[]).map((d,i)=>depRow(i,d.motif,d.montant)).join('')}</div>
      <button class="btn btn-secondary btn-sm mt-8" onclick="addDep()">${ICONS.plus} Ajouter une dépense</button>
      <button class="btn btn-secondary btn-sm mt-8" onclick="addConv()">${ICONS.plus} Ajouter un converti</button>
          <button class="btn btn-primary" onclick="saveRap()">${ICONS.save} Enregistrer</button>
          <button class="btn btn-gold" onclick="saveAndPDF()">${ICONS.file} Sauvegarder & PDF</button>
          <button class="btn btn-success" onclick="saveAndDOCX()">${ICONS.pen} Sauvegarder & DOCX</button>
      <button class="btn btn-danger btn-sm btn-icon" onclick="removeDep(this)">${ICONS.x}</button>
      <button class="btn btn-danger btn-sm btn-icon" onclick="removeConv(this)">${ICONS.x}</button>
  </div>`;
}

// Save current step data into _rap
function saveStep(){
  const g=id=>{const el=document.getElementById(id);return el?el.value.trim():'';}
  const n=id=>{const el=document.getElementById(id);return parseFloat(el?.value||0)||0;}
  switch(_step){
    case 0:
      _rap.date=g('s-date')||_rap.date;
      _rap.heureDebut=g('s-hd');_rap.heureFin=g('s-hf');
      _rap.moderateur=g('s-mod');_rap.predicateur=g('s-pred');
      _rap.interprete=g('s-interp');_rap.textes=g('s-tex');_rap.theme=g('s-theme');
      break;
    case 1:{
      const p=n('eff-papas'),ma=n('eff-mamans'),f=n('eff-freres'),so=n('eff-soeurs'),e=n('eff-enfants');
      _rap.effectif={papas:p,mamans:ma,freres:f,soeurs:so,enfants:e,total:p+ma+f+so+e};
      break;}
    case 2:{
      const ord=n('off-ord'),or=n('off-or'),dim=n('off-dim'),ag=n('off-ag');
      const tot=+(ord+or+dim+ag).toFixed(2);
      _rap.offrandes={ordinaires:ord,orateur:or,dimes:dim,actionsGrace:ag,total:tot};
      _rap.ventilation={dixPctDime:+(dim*.1).toFixed(2),dixPctSocial:+(tot*.1).toFixed(2),reste:+(tot*.8).toFixed(2)};
      break;}
    case 3:{
      const rows=document.querySelectorAll('#dep-list .dep-row');
      _rap.depenses=[];
      rows.forEach(row=>{
        const m=row.querySelector('.dep-m')?.value.trim();
        const v=parseFloat(row.querySelector('.dep-v')?.value||0)||0;
        if(m||v) _rap.depenses.push({motif:m||'',montant:v});
      });
      _rap.totalDepenses=+(_rap.depenses.reduce((s,d)=>s+d.montant,0)).toFixed(2);
      _rap.soldeFinal=+((_rap.offrandes?.total||0)-_rap.totalDepenses).toFixed(2);
      break;}
    case 4:{
      const rows=document.querySelectorAll('#conv-list .conv-row');
      _rap.nouveaux=[];
      rows.forEach(row=>{
        const nm=row.querySelector('.conv-n')?.value.trim();
        const tl=row.querySelector('.conv-t')?.value.trim();
        if(nm) _rap.nouveaux.push({nom:nm,tel:tl||''});
      });
      break;}
    case 5:
      _rap.signatures={secretaire:g('sig-sec'),tresorier:g('sig-tres'),pasteur:g('sig-past')};
      break;
  }
}

function goToStep(n){
  if(n<0||n>=STEPS.length) return;
  saveStep();
  _step=n;
  // update stepper
  document.querySelector('.stepper').innerHTML=buildStepper();
  // update step body
  document.getElementById('step-body').innerHTML=buildStep(_step);
  // update nav buttons
  const nb=document.getElementById('step-btns');
  nb.innerHTML=`${_step>0?`<button class="btn btn-secondary" onclick="goPrevStep()">← Précédent</button>`:'<div></div>'}${_step<STEPS.length-1?`<button class="btn btn-primary" onclick="goNextStep()">Suivant →</button>`:''}`;
}

window.goNextStep=function(){goToStep(_step+1);};
window.goPrevStep=function(){goToStep(_step-1);};
window.jumpStep=function(n){goToStep(n);};

// Realtime calc
window.recalcEff=function(){
  const n=id=>parseInt(document.getElementById(id)?.value||0)||0;
  const tot=n('eff-papas')+n('eff-mamans')+n('eff-freres')+n('eff-soeurs')+n('eff-enfants');
  const el=document.getElementById('eff-total'); if(el)el.textContent=tot+' personnes';
};
window.recalcOff=function(){
  const ext=Store.getExt(_extId); const sym=ext?.symbole||'€';
  const n=id=>parseFloat(document.getElementById(id)?.value||0)||0;
  const ord=n('off-ord'),or=n('off-or'),dim=n('off-dim'),ag=n('off-ag');
  const tot=+(ord+or+dim+ag).toFixed(2);
  const s=id=>{ const el=document.getElementById(id); if(el)el.textContent=fmt(arguments[1]||0,sym); };
  const set=(id,v)=>{ const el=document.getElementById(id); if(el)el.textContent=fmt(v,sym); };
  set('off-total',tot); set('v-dime',+(dim*.1).toFixed(2)); set('v-soc',+(tot*.1).toFixed(2)); set('v-reste',+(tot*.8).toFixed(2));
};
window.recalcDep=function(){
  const ext=Store.getExt(_extId); const sym=ext?.symbole||'€';
  const dep=[...document.querySelectorAll('#dep-list .dep-v')].reduce((s,el)=>s+(parseFloat(el.value)||0),0);
  const sol=(_rap.offrandes?.total||0)-dep;
  const set=(id,v)=>{ const el=document.getElementById(id); if(el)el.textContent=fmt(v,sym); };
  set('dep-tot',dep); set('dep-sol',sol);
};

window.addDep=function(){
  const list=document.getElementById('dep-list');
  const i=list.querySelectorAll('.dep-row').length;
  list.insertAdjacentHTML('beforeend',depRow(i));
};
window.removeDep=function(btn){btn.closest('.dep-row').remove();recalcDep();};

window.addConv=function(){
  const list=document.getElementById('conv-list');
  const i=list.querySelectorAll('.conv-row').length;
  list.insertAdjacentHTML('beforeend',convRow(i));
  const cnt=document.getElementById('conv-cnt');
  if(cnt)cnt.textContent=String(list.querySelectorAll('.conv-row').length);
};
window.removeConv=function(btn){
  btn.closest('.conv-row').remove();
  const cnt=document.getElementById('conv-cnt');
  const list=document.getElementById('conv-list');
  if(cnt&&list)cnt.textContent=String(list.querySelectorAll('.conv-row').length);
};

window.saveRap=function(){
  saveStep();
  if(!_rap.date){toast('La date est obligatoire','error');return;}
  Store.saveRap(_rap);
  toast('Rapport enregistré !','success');
  navTo('/ext/rapports');
};
window.saveAndPDF=function(){saveStep();if(!_rap.date){toast('Date obligatoire','error');return;}Store.saveRap(_rap);doExportPDF(_rap.id);};
window.saveAndDOCX=function(){saveStep();if(!_rap.date){toast('Date obligatoire','error');return;}Store.saveRap(_rap);doExportDOCX(_rap.id);};

// ═══════════════════════════════════════════════
// VIEW RAPPORT MODAL
// ═══════════════════════════════════════════════
window.showRapModal=function(id){
  const r=Store.getRap(id); if(!r){toast('Rapport introuvable','error');return;}
  const ext=Store.getExt(r.extensionId);
  const sym=ext?.symbole||'€';
  function kv(k,v){return`<div class="calc-row"><span>${k}</span><span>${v}</span></div>`;}
  openModal(`
    <div class="modal-header">
      <h2>Rapport · ${fmtD(r.date)}</h2>
      <button class="modal-close" onclick="closeModal()">${ICONS.x}</button>
    </div>
    <div class="modal-body">
      <div class="form-section-title mb-8">Culte</div>
      <div class="calc-box mb-12">
        ${kv('Date',fmtD(r.date))}${kv('Heure',(r.heureDebut||'—')+' → '+(r.heureFin||'—'))}
        ${kv('Modérateur',r.moderateur||'—')}${kv('Prédicateur',r.predicateur||'—')}
        ${kv('Thème',r.theme||'—')}${kv('Textes',r.textes||'—')}
      </div>
      <div class="form-section-title mb-8">Effectif</div>
      <div class="calc-box mb-12">
        ${kv('Papas',r.effectif?.papas||0)}${kv('Mamans',r.effectif?.mamans||0)}
        ${kv('Frères',r.effectif?.freres||0)}${kv('Sœurs',r.effectif?.soeurs||0)}
        ${kv('Enfants',r.effectif?.enfants||0)}
        <div class="calc-row total-row"><span>Total</span><span>${r.effectif?.total||0}</span></div>
      </div>
      <div class="form-section-title mb-8">Offrandes</div>
      <div class="calc-box mb-12">
        ${kv('Ordinaires',fmt(r.offrandes?.ordinaires,sym))}${kv('Orateur',fmt(r.offrandes?.orateur,sym))}
        ${kv('Dîmes',fmt(r.offrandes?.dimes,sym))}${kv('Actions de Grâce',fmt(r.offrandes?.actionsGrace,sym))}
        <div class="calc-row total-row"><span>Total</span><span>${fmt(r.offrandes?.total,sym)}</span></div>
      </div>
      <div class="form-section-title mb-8">Ventilation</div>
      <div class="calc-box mb-12">
        ${kv('10% Dîmes',fmt(r.ventilation?.dixPctDime,sym))}
        ${kv('10% Social',fmt(r.ventilation?.dixPctSocial,sym))}
        <div class="calc-row total-row"><span>Reste</span><span>${fmt(r.ventilation?.reste,sym)}</span></div>
      </div>
      ${r.depenses?.length?`
        <div class="form-section-title mb-8">Dépenses</div>
        <div class="calc-box mb-12">
          ${r.depenses.map(d=>kv(d.motif,fmt(d.montant,sym))).join('')}
          <div class="calc-row total-row"><span>Solde final</span><span>${fmt(r.soldeFinal,sym)}</span></div>
        </div>`:''}
      ${r.nouveaux?.length?`
        <div class="form-section-title mb-8">Convertis (${r.nouveaux.length})</div>
        <div class="calc-box mb-12">
          ${r.nouveaux.map(n=>kv(n.nom,n.tel||'—')).join('')}
        </div>`:''}
      <div class="form-section-title mb-8">Signatures</div>
      <div class="calc-box">
        ${kv('Secrétaire',r.signatures?.secretaire||'—')}
        ${kv('Trésorier',r.signatures?.tresorier||'—')}
        ${kv('Pasteur',r.signatures?.pasteur||'—')}
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
      <button class="btn btn-gold" onclick="doExportPDF('${r.id}')">${ICONS.file} PDF</button>
      <button class="btn btn-success" onclick="doExportDOCX('${r.id}')">${ICONS.pen} DOCX</button>
    </div>`,true);
};

// ═══════════════════════════════════════════════
// EXPORT — PDF
// ═══════════════════════════════════════════════
window.doExportPDF=async function(rapId){
  const r=Store.getRap(rapId);
  if(!r){toast('Rapport introuvable','error');return;}
  const ext=Store.getExt(r.extensionId);
  const logo=Store.getLogo();
  const cfg=Store.getSet();
  const sym=ext?.symbole||'€';
  const rgb=hexRgb(ext?.couleur||'#8B5CF6');
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=15; let y=8;

  // color bar top
  doc.setFillColor(...rgb); doc.rect(0,0,W,5,'F');

  // header
  if(logo){try{doc.addImage(logo,'PNG',M,y+1,24,24);}catch(e){}}
  doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(...rgb);
  doc.text(cfg.nom||'Emerge in Christ',W/2,y+8,{align:'center'});
  doc.setFontSize(10); doc.setFont('helvetica','normal'); doc.setTextColor(100,100,120);
  doc.text('Extension : '+(ext?.nom||''),W/2,y+15,{align:'center'});
  doc.text('RAPPORT DE CULTE',W/2,y+21,{align:'center'});
  y+=30; doc.setDrawColor(210,210,225); doc.line(M,y,W-M,y); y+=7;

  // Culte
  pSec(doc,'INFORMATIONS DU CULTE',M,y,rgb); y+=7;
  const info=[['Date',fmtD(r.date)],['Heure',(r.heureDebut||'—')+' → '+(r.heureFin||'—')],
    ['Modérateur',r.moderateur||''],['Prédicateur',r.predicateur||''],
    ['Interprète',r.interprete||''],['Thème',r.theme||''],['Textes',r.textes||'']];
  info.forEach(([k,v])=>{
    doc.setFont('helvetica','bold');doc.setFontSize(8.5);doc.setTextColor(60,60,80);doc.text(k+' :',M,y);
    doc.setFont('helvetica','normal');doc.setTextColor(80,80,100);
    doc.text(String(v||''),M+32,y,{maxWidth:W-M-32-5});y+=5;
  });
  y+=3;

  // Effectif
  pSec(doc,'EFFECTIF',M,y,rgb); y+=7;
  const eff=r.effectif||{};
  pTable(doc,[['Papas','Mamans','Frères','Sœurs','Enfants','TOTAL'],
    [eff.papas,eff.mamans,eff.freres,eff.soeurs,eff.enfants,eff.total].map(v=>String(v||0))],
    M,y,W-2*M,[30,30,30,30,30,26]); y+=15;

  // Offrandes
  pSec(doc,'OFFRANDES',M,y,rgb); y+=7;
  const off=r.offrandes||{};
  pRows(doc,[['Ordinaires',fmt(off.ordinaires,sym)],['Orateur',fmt(off.orateur,sym)],
    ['Dîmes',fmt(off.dimes,sym)],['Actions de Grâce',fmt(off.actionsGrace,sym)],
    ['TOTAL OFFRANDES',fmt(off.total,sym)]],M,y,W-2*M); y+=33;

  // Ventilation
  pSec(doc,'VENTILATION FINANCIÈRE',M,y,rgb); y+=7;
  const vent=r.ventilation||{};
  pRows(doc,[['10% Dîmes (local)',fmt(vent.dixPctDime,sym)],['10% Social',fmt(vent.dixPctSocial,sym)],
    ['Reste',fmt(vent.reste,sym)]],M,y,W-2*M); y+=21;

  // Dépenses
  if(r.depenses?.length){
    pSec(doc,'DÉPENSES',M,y,rgb); y+=7;
    const drows=r.depenses.map((d,i)=>[String(i+1),d.motif||'',fmt(d.montant,sym)]);
    drows.push(['','TOTAL DÉPENSES',fmt(r.totalDepenses,sym)],['','SOLDE FINAL',fmt(r.soldeFinal,sym)]);
    pTable(doc,[['N°','Motif','Montant'],...drows],M,y,W-2*M,[14,100,42]);
    y+=(r.depenses.length+3)*6+5;
  }

  // Convertis
  if(r.nouveaux?.length){
    if(y+25>282){doc.addPage();y=15;}
    pSec(doc,'NOUVEAUX CONVERTIS',M,y,rgb); y+=7;
    pTable(doc,[['N°','Nom complet','Téléphone'],...r.nouveaux.map((n,i)=>[String(i+1),n.nom||'',n.tel||''])],
      M,y,W-2*M,[14,106,36]); y+=(r.nouveaux.length+1)*6+5;
  }

  // Signatures
  if(y+32>282){doc.addPage();y=15;}
  pSec(doc,'SIGNATURES',M,y,rgb); y+=10;
  const sW=(W-2*M)/3;
  [{role:'Secrétaire',name:r.signatures?.secretaire},{role:'Trésorier',name:r.signatures?.tresorier},{role:'Pasteur Principal',name:r.signatures?.pasteur}]
    .forEach((sig,i)=>{
      const x=M+i*sW;
      doc.setFont('helvetica','bold');doc.setFontSize(8.5);doc.setTextColor(80,80,100);
      doc.text(sig.role,x+sW/2,y,{align:'center'});
      if(sig.name){doc.setFont('helvetica','italic');doc.setFontSize(8);doc.setTextColor(120,120,140);doc.text(sig.name||'',x+sW/2,y+5,{align:'center'});}
      doc.setDrawColor(180,180,200);doc.line(x+4,y+14,x+sW-4,y+14);
    });

  doc.setFillColor(...rgb); doc.rect(0,290,W,7,'F');
  doc.save(`Rapport_${(ext?.nom||'EIC').replace(/\s+/g,'_')}_${r.date||'export'}.pdf`);
  toast('PDF exporté !','success');
};

// PDF helpers
function pSec(doc,text,x,y,rgb){
  doc.setFillColor(...rgb); doc.rect(x,y-4,180,7,'F');
  doc.setFont('helvetica','bold');doc.setFontSize(8.5);doc.setTextColor(255,255,255);
  doc.text(text,x+2,y);
}
function pRows(doc,rows,x,y,width){
  const c1=width*.58;
  rows.forEach((row,i)=>{
    doc.setFillColor(...(i%2===0?[245,243,255]:[255,255,255])); doc.rect(x,y-3,width,6,'F');
    doc.setFont('helvetica',i===rows.length-1?'bold':'normal');doc.setFontSize(8.5);doc.setTextColor(60,60,80);
    doc.text(String(row[0]||''),x+2,y);
    doc.text(String(row[1]||''),x+width-2,y,{align:'right'});
    y+=6;
  });
}
function pTable(doc,rows,x,y,width,colW){
  const sc=width/colW.reduce((a,b)=>a+b,0);
  const scaled=colW.map(w=>w*sc);
  rows.forEach((row,ri)=>{
    const isH=ri===0;
    doc.setFillColor(...(isH?[139,92,246]:ri%2===0?[245,243,255]:[255,255,255]));
    doc.rect(x,y-4,width,6,'F');
    let cx=x;
    row.forEach((cell,ci)=>{
      doc.setFont('helvetica',isH?'bold':'normal');doc.setFontSize(8);
      doc.setTextColor(isH?255:60,isH?255:60,isH?255:80);
      doc.text(String(cell||''),cx+1,y,{maxWidth:scaled[ci]-2});
      cx+=scaled[ci];
    });
    y+=6;
  });
}

// ═══════════════════════════════════════════════
// EXPORT — DOCX
// ═══════════════════════════════════════════════
window.doExportDOCX=async function(rapId){
  const r=Store.getRap(rapId); if(!r){toast('Rapport introuvable','error');return;}
  const ext=Store.getExt(r.extensionId);
  const sym=ext?.symbole||'€';
  const cfg=Store.getSet();
  const {Document,Packer,Paragraph,Table,TableRow,TableCell,TextRun,HeadingLevel,AlignmentType,WidthType,BorderStyle}=window.docx;

  const hdr=(text,level)=>new Paragraph({text,heading:level||HeadingLevel.HEADING_2});
  const blk=()=>new Paragraph('');
  const kv=(k,v)=>new Paragraph({children:[new TextRun({text:k+': ',bold:true,size:20}),new TextRun({text:String(v||'—'),size:20})]});
  const mkTbl=(hdrs,bodyRows)=>new Table({
    width:{size:100,type:WidthType.PERCENTAGE},
    rows:[
      new TableRow({children:hdrs.map(h=>new TableCell({shading:{fill:'EDE9FE'},children:[new Paragraph({children:[new TextRun({text:h,bold:true,size:18})]})]})),tableHeader:true}),
      ...bodyRows.map(cells=>new TableRow({children:cells.map(c=>new TableCell({children:[new Paragraph({children:[new TextRun({text:String(c??''),size:18})]})]}))}))
    ]
  });

  const children=[
    new Paragraph({text:`${cfg.nom||'Emerge in Christ'} — ${ext?.nom||''}`,heading:HeadingLevel.HEADING_1,alignment:AlignmentType.CENTER}),
    new Paragraph({text:'RAPPORT DE CULTE',heading:HeadingLevel.HEADING_2,alignment:AlignmentType.CENTER}),
    blk(),
    hdr('INFORMATIONS DU CULTE',HeadingLevel.HEADING_3),
    kv('Date',fmtD(r.date)),kv('Heure',(r.heureDebut||'—')+' → '+(r.heureFin||'—')),
    kv('Modérateur',r.moderateur),kv('Prédicateur',r.predicateur),
    kv('Thème',r.theme),kv('Textes bibliques',r.textes),blk(),
    hdr('EFFECTIF',HeadingLevel.HEADING_3),
    mkTbl(['Papas','Mamans','Frères','Sœurs','Enfants','Total'],
      [[r.effectif?.papas||0,r.effectif?.mamans||0,r.effectif?.freres||0,r.effectif?.soeurs||0,r.effectif?.enfants||0,r.effectif?.total||0]]),
    blk(),
    hdr('OFFRANDES',HeadingLevel.HEADING_3),
    mkTbl(['Type','Montant'],[
      ['Ordinaires',fmt(r.offrandes?.ordinaires,sym)],['Orateur',fmt(r.offrandes?.orateur,sym)],
      ['Dîmes',fmt(r.offrandes?.dimes,sym)],['Actions de Grâce',fmt(r.offrandes?.actionsGrace,sym)],
      ['TOTAL',fmt(r.offrandes?.total,sym)]]),
    blk(),
    hdr('VENTILATION FINANCIÈRE',HeadingLevel.HEADING_3),
    mkTbl(['Type','Montant'],[
      ['10% Dîmes (local)',fmt(r.ventilation?.dixPctDime,sym)],
      ['10% Social',fmt(r.ventilation?.dixPctSocial,sym)],
      ['Reste',fmt(r.ventilation?.reste,sym)]]),
    blk(),
  ];
  if(r.depenses?.length){
    children.push(hdr('DÉPENSES',HeadingLevel.HEADING_3));
    children.push(mkTbl(['N°','Motif','Montant'],[
      ...r.depenses.map((d,i)=>[i+1,d.motif||'',fmt(d.montant,sym)]),
      ['','TOTAL DÉPENSES',fmt(r.totalDepenses,sym)],
      ['','SOLDE FINAL',fmt(r.soldeFinal,sym)]
    ]));
    children.push(blk());
  }
  if(r.nouveaux?.length){
    children.push(hdr('NOUVEAUX CONVERTIS',HeadingLevel.HEADING_3));
    children.push(mkTbl(['Nom','Téléphone'],r.nouveaux.map(n=>[n.nom||'',n.tel||''])));
    children.push(blk());
  }
  children.push(hdr('SIGNATURES',HeadingLevel.HEADING_3));
  children.push(mkTbl(['Secrétaire','Trésorier','Pasteur Principal'],
    [[r.signatures?.secretaire||'',r.signatures?.tresorier||'',r.signatures?.pasteur||'']]));

  const wordDoc=new Document({sections:[{properties:{},children}]});
  const blob=await Packer.toBlob(wordDoc);
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`Rapport_${(ext?.nom||'EIC').replace(/\s+/g,'_')}_${r.date||'export'}.docx`;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('DOCX exporté !','success');
};

// ═══════════════════════════════════════════════
// EXPORT — BILAN PDF
// ═══════════════════════════════════════════════
window.doExportBilanPDF=function(type,extId,year,month){
  // type: string, extId: string or '', year: number, month: number
  const yr=parseInt(year)||new Date().getFullYear();
  const mo=parseInt(month)||0;
  const ext=extId?Store.getExt(extId):null;
  const logo=Store.getLogo();
  const cfg=Store.getSet();
  const sym=ext?.symbole||'€';
  const rgb=hexRgb(ext?.couleur||'#8B5CF6');

  const raps=Store.getRaps(extId||null).filter(r=>{
    const d=new Date(r.date+'T00:00');
    if(d.getFullYear()!==yr) return false;
    if(type==='mensuel') return d.getMonth()===mo;
    if(type==='trimestriel') return Math.floor(d.getMonth()/3)===Math.floor(mo/3);
    return true;
  });

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
  const W=210,M=15; let y=8;
  doc.setFillColor(...rgb); doc.rect(0,0,W,5,'F');
  if(logo){try{doc.addImage(logo,'PNG',M,y,22,22);}catch(e){}}
  doc.setFont('helvetica','bold');doc.setFontSize(15);doc.setTextColor(...rgb);
  doc.text(cfg.nom||'Emerge in Christ',W/2,y+7,{align:'center'});
  doc.setFontSize(11);doc.setFont('helvetica','normal');doc.setTextColor(80,80,100);
  const typeLabel=type==='mensuel'?`BILAN MENSUEL — ${mName(mo).toUpperCase()} ${yr}`:
    type==='trimestriel'?`BILAN TRIMESTRIEL — T${Math.floor(mo/3)+1} ${yr}`:`BILAN ANNUEL — ${yr}`;
  doc.text(typeLabel,W/2,y+14,{align:'center'});
  if(ext)doc.text('Extension : '+ext.nom,W/2,y+20,{align:'center'});
  y+=30; doc.setDrawColor(200,200,220); doc.line(M,y,W-M,y); y+=8;

  const tPres=raps.reduce((s,r)=>s+(r.effectif?.total||0),0);
  const tOff=raps.reduce((s,r)=>s+(r.offrandes?.total||0),0);
  const tDep=raps.reduce((s,r)=>s+(r.totalDepenses||0),0);
  const tNouv=raps.reduce((s,r)=>s+(r.nouveaux?.length||0),0);

  pSec(doc,'RÉSUMÉ DE LA PÉRIODE',M,y,rgb); y+=7;
  pRows(doc,[
    ['Nombre de cultes',String(raps.length)],
    ['Présence totale',String(tPres)],
    ['Présence moyenne',raps.length?String(Math.round(tPres/raps.length)):'0'],
    ['Total offrandes',fmt(tOff,sym)],
    ['Total dépenses',fmt(tDep,sym)],
    ['Solde net',fmt(tOff-tDep,sym)],
    ['Nouveaux convertis',String(tNouv)],
  ],M,y,W-2*M); y+=49;

  if(raps.length>0){
    pSec(doc,'DÉTAIL PAR CULTE',M,y,rgb); y+=7;
    const detailRows=raps.map(r=>[
      fmtD(r.date),String(r.effectif?.total||0),
      fmt(r.offrandes?.total,sym),fmt(r.totalDepenses,sym),
      fmt((r.offrandes?.total||0)-(r.totalDepenses||0),sym),
      String(r.nouveaux?.length||0)
    ]);
    pTable(doc,[['Date','Prés.','Offrandes','Dépenses','Solde','Conv.'],...detailRows],
      M,y,W-2*M,[36,18,32,32,32,16]);
  }
  doc.setFillColor(...rgb); doc.rect(0,290,W,7,'F');
  doc.save(`${typeLabel.replace(/[\s—]+/g,'_')}_${ext?.nom||'Reseau'}.pdf`);
  toast('Bilan PDF exporté !','success');
};

// Expose all needed globals
window.Store=Store;
window.pgAdminExts=pgAdminExts;
window.pgAdminSettings=pgAdminSettings;
window.pgExtRaps=pgExtRaps;
window.closeModal=closeModal;
window.openModal=openModal;
window.navTo=navTo;
</script>
</body>
</html>
